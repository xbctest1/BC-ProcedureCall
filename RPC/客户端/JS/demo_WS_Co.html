<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
</head>
<body>
<button onclick="btn_onclick()">按钮</button>
</body>
</html>

<script src="BCrpcWS_Co.js"></script>
<script>
var rpc = new BCrpcWS_Co('127.0.0.1:8000', 2);

rpc.setcbOption(function () {
	console.log('首次连接上(包括重连)');
}, 2, 1, 1); //心跳根据实际需求配置

function msgloop(self, r, dat, len) {
	console.log(r, dat)
	//若返回假表示用户手动退出(不继续消息循环)
	return true;
}

rpc.waitMsgLoop(msgloop, function (isContinue) {
	if (!isContinue) {
		console.log('用户手动退出消息循环');
		return;
	}
	console.log('已断开,1秒后再次重连');
	this.resumeMsgLoop(1);
});


// 并发调用
console.log('下面是并发请求');
testCall(1);
testCall(2);
console.log('并发请求结束');


// 测试协程化调用
async function testCall(msg) {
	//返回值必须严格投入名称{r,rx}，也可以仅投入一个{r}
	var {r, rx} = await rpc.call(msg, b('hello'));
	console.log(r, rx)
}

// 按协程顺序执行多个调用
async function btn_onclick() {
	console.log('开始第一个调用');
	var {r} = await rpc.call(111, b('hello')); //仅接收r
	console.log(`第一个调用完成(返回值:${r})，开始第二个调用`);
	await testCall(222);
	console.log('所有调用完成');
}
</script>
